import{d as e,r as l,a,b as t,o as r,h as u,w as o,t as d,v as i,f as s,q as p,i as n,x as m,u as c,g as v,y as _,z as w}from"./index-6dfdc0ee.js";import{_ as g}from"./Dialog.vue_vue_type_style_index_0_lang-6e721bb1.js";import{_ as f}from"./CustomerDialog.vue_vue_type_script_setup_true_lang-f2c5b605.js";import{_ as b}from"./ProductDialog.vue_vue_type_script_setup_true_lang-03d938c9.js";import{_ as h}from"./_plugin-vue_export-helper-1b428a4d.js";import"./CustomerManage.vue_vue_type_script_setup_true_name_CustomerManage_lang-e25c68d2.js";import"./index.vue_vue_type_script_setup_true_name_ProTable_lang-25415f8a.js";import"./print-7c839e56.js";import"./index-d897ae39.js";import"./enum-ebf888b2.js";import"./CustomerDialog.vue_vue_type_script_setup_true_lang-a24c0c3c.js";import"./useHandleData-bcc6e8c1.js";import"./ProductManage.vue_vue_type_script_setup_true_name_ProductManage_lang-ed63003d.js";import"./ProductDialog.vue_vue_type_script_setup_true_lang-c7213267.js";import"./ProductStateDialog.vue_vue_type_script_setup_true_lang-52d28081.js";const y={class:"flex",style:{width:"100%"}},V={class:"flex",style:{width:"100%"}},x={class:"flex",style:{width:"100%"}},T={style:{width:"100%"}},D={style:{display:"flex","justify-content":"center",width:"100%","margin-top":"10px"}},k=h(e({__name:"ContractDialog",setup(e,{expose:h}){const k=l(!1),j=l({isView:!1,title:"",row:{products:[]},labelWidth:120,fullscreen:!1,maxHeight:"500px"});h({acceptParams:e=>{const l={products:[],...e.row};l.products||(l.products=[]),j.value={...j.value,...e,row:l},k.value=!0}});const C=a({name:[{required:!0,message:"请输入合同名称",trigger:"blur"}],customerId:[{required:!0,message:"请选择客户",trigger:"blur"}],startTime:[{required:!0,message:"请选择合同开始时间",trigger:"blur"}],endTime:[{required:!0,message:"请选择合同结束时间",trigger:"blur"},{validator:(e,l,a)=>{l?j.value.row.startTime&&new Date(l)<new Date(j.value.row.endTime)?a(new Error("合同结束时间不能早于开始时间")):a():a(new Error("请选择合同结束时间"))},trigger:"blur"}],signTime:[{required:!0,message:"请选择合同签约时间",trigger:"blur"}]}),P=()=>{j.value.row.products||(j.value.row.products=[]),j.value.row.products.push({pName:"",pId:0,price:0,count:1,totalPrice:0})},U=e=>{e&&void 0!==e.price&&void 0!==e.count&&(e.totalPrice=e.price*e.count,Y())},Y=()=>{if(!j.value.row.products||0===j.value.row.products.length)return void(j.value.row.amount=0);const e=j.value.row.products.reduce((e,l)=>e+(l.totalPrice||0),0);j.value.row.amount=e},M=l(),N=()=>{M.value.validate(async e=>{if(!e)return;if(!j.value.row.products||0===j.value.row.products.length)return void w.warning("请至少添加一个产品");if(j.value.row.products.filter(e=>!e.pId||!e.pName).length>0)w.warning("请为所有产品选择具体商品");else try{const e={...j.value.row};delete e.updateTime,delete e.createTime,await j.value.api(e),w.success({message:`${j.value.title}成功！`}),j.value.getTableList(),k.value=!1,M.value.resetFields(),q(!0)}catch(l){w.error(`${j.value.title}失败`)}})},q=e=>{k.value=!1;(["查看","编辑"].includes(j.value.title)||e)&&(j.value.row={products:[]},M.value.resetFields())},I=l(),$=e=>{I.value.acceptParams({title:"客户列表"}),e&&e.id&&e.name&&(j.value.row.customerId=String(e.id),j.value.row.customerName=e.name)},H=l(),R=l(0),A=e=>{const l=R.value;j.value.row.products&&j.value.row.products[l]&&(null==e?void 0:e.id)&&(null==e?void 0:e.name)&&(null==e?void 0:e.price)&&(j.value.row.products[l].pId=e.id,j.value.row.products[l].pName=e.name,j.value.row.products[l].price=e.price,j.value.row.products[l].count&&0!==j.value.row.products[l].count||(j.value.row.products[l].count=1),U(j.value.row.products[l]))};return(e,l)=>{const a=t("el-input"),w=t("el-form-item"),h=t("el-button"),E=t("el-date-picker"),F=t("el-divider"),G=t("el-table-column"),S=t("el-input-number"),W=t("el-table"),z=t("el-form");return r(),u(c(g),{"model-value":k.value,title:j.value.title,fullscreen:j.value.fullscreen,"max-height":j.value.maxHeight,"cancel-dialog":q,width:"75%",top:"8vh"},{footer:o(()=>[d(e.$slots,"footer",{},()=>[s(h,{onClick:q},{default:o(()=>[...l[14]||(l[14]=[n("取消",-1)])]),_:1}),v(s(h,{type:"primary",onClick:N},{default:o(()=>[...l[15]||(l[15]=[n("确定",-1)])]),_:1},512),[[_,!j.value.isView]])],!0)]),default:o(()=>[i("div",{style:m("width: calc(100% - "+j.value.labelWidth/2+"px)")},[s(z,{ref_key:"ruleFormRef",ref:M,"label-position":"right","label-width":j.value.labelWidth+"px",rules:C,model:j.value.row,disabled:j.value.isView,"hide-required-asterisk":j.value.isView},{default:o(()=>[j.value.row.id?(r(),u(w,{key:0,label:"合同编号",prop:"number"},{default:o(()=>[s(a,{modelValue:j.value.row.number,"onUpdate:modelValue":l[0]||(l[0]=e=>j.value.row.number=e),readonly:"true","show-word-limit":""},null,8,["modelValue"])]),_:1})):p("",!0),s(w,{label:"合同名称",prop:"name"},{default:o(()=>[s(a,{modelValue:j.value.row.name,"onUpdate:modelValue":l[1]||(l[1]=e=>j.value.row.name=e),clearable:"",maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),s(w,{label:"签约客户",prop:"customerId"},{default:o(()=>[i("div",y,[s(a,{modelValue:j.value.row.customerName,"onUpdate:modelValue":l[2]||(l[2]=e=>j.value.row.customerName=e),placeholder:"请选择要签约的客户",class:"mr-18px",disabled:""},null,8,["modelValue"]),s(h,{type:"primary",onClick:$},{default:o(()=>[...l[9]||(l[9]=[n("客户信息",-1)])]),_:1}),s(f,{ref_key:"customerRef",ref:I,onGetCustomerData:$},null,512)])]),_:1}),i("div",V,[s(w,{label:"合同开始时间",prop:"startTime"},{default:o(()=>[s(E,{modelValue:j.value.row.startTime,"onUpdate:modelValue":l[3]||(l[3]=e=>j.value.row.startTime=e),type:"date",placeholder:"选择合同开始时间","value-format":"YYYY-MM-DD","disabled-date":e=>e.getTime()<Date.now()-864e5},null,8,["modelValue","disabled-date"])]),_:1}),s(w,{label:"合同结束时间",prop:"endTime"},{default:o(()=>[s(E,{modelValue:j.value.row.endTime,"onUpdate:modelValue":l[4]||(l[4]=e=>j.value.row.endTime=e),type:"date",placeholder:"选择合同结束时间","value-format":"YYYY-MM-DD","disabled-date":e=>e.getTime()<Date.now()-864e5},null,8,["modelValue","disabled-date"])]),_:1}),s(w,{label:"合同签约时间",prop:"signTime"},{default:o(()=>[s(E,{modelValue:j.value.row.signTime,"onUpdate:modelValue":l[5]||(l[5]=e=>j.value.row.signTime=e),type:"date",placeholder:"选择合同签约时间","value-format":"YYYY-MM-DD","disabled-date":e=>e.getTime()<Date.now()-864e5},null,8,["modelValue","disabled-date"])]),_:1})]),i("div",x,[s(w,{label:"合同总金额",prop:"amount",style:{flex:"1"}},{default:o(()=>[s(a,{modelValue:j.value.row.amount,"onUpdate:modelValue":l[6]||(l[6]=e=>j.value.row.amount=e),clearable:"",readonly:"true"},null,8,["modelValue"])]),_:1}),s(w,{label:"已收款项",prop:"receivedAmount",style:{flex:"1"}},{default:o(()=>[s(a,{modelValue:j.value.row.receivedAmount,"onUpdate:modelValue":l[7]||(l[7]=e=>j.value.row.receivedAmount=e),clearable:"",readonly:"true"},null,8,["modelValue"])]),_:1})]),s(w,{label:"备注",prop:"remark"},{default:o(()=>[s(a,{modelValue:j.value.row.remark,"onUpdate:modelValue":l[8]||(l[8]=e=>j.value.row.remark=e),clearable:"",type:"textarea",maxlength:"100","show-word-limit":""},null,8,["modelValue"])]),_:1}),i("div",T,[l[13]||(l[13]=i("h2",null,"合同产品关系",-1)),s(F),s(W,{data:j.value.row.products,border:"",style:{width:"100%"}},{default:o(()=>[s(G,{prop:"pName",label:"商品录入","min-width":"140"},{default:o(e=>[s(a,{modelValue:e.row.pName,"onUpdate:modelValue":l=>e.row.pName=l,placeholder:"请输入商品",style:{width:"180px"}},null,8,["modelValue","onUpdate:modelValue"]),s(h,{type:"primary",style:{"margin-left":"5px"},onClick:l=>{return a=e.$index,R.value=a,void H.value.acceptParams({title:"商品列表"});var a}},{default:o(()=>[...l[10]||(l[10]=[n("选择商品",-1)])]),_:1},8,["onClick"])]),_:1}),s(G,{prop:"price",label:"单价"}),s(G,{prop:"count",label:"数量"},{default:o(e=>[s(S,{modelValue:e.row.count,"onUpdate:modelValue":l=>e.row.count=l,min:1,onChange:l=>U(e.row),style:{width:"100px"}},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),s(G,{prop:"totalPrice",label:"小计"}),s(G,{label:"操作"},{default:o(e=>[s(h,{type:"danger",size:"small",link:"",onClick:l=>{return a=e.$index,void(j.value.row.products&&j.value.row.products.length>a&&(j.value.row.products.splice(a,1),Y()));var a}},{default:o(()=>[...l[11]||(l[11]=[n(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),i("div",D,[s(h,{type:"primary",onClick:P},{default:o(()=>[...l[12]||(l[12]=[n(" + 添加合同产品关系 ",-1)])]),_:1})])])]),_:1},8,["label-width","rules","model","disabled","hide-required-asterisk"]),s(b,{ref_key:"productRef",ref:H,onGetProductData:A},null,512)],4)]),_:3},8,["model-value","title","fullscreen","max-height"])}}}),[["__scopeId","data-v-8caa5b80"]]);export{k as default};
